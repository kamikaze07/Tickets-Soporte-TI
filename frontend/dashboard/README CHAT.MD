ğŸ“˜ README â€“ MÃ³dulo de Chat (Usuario & Admin)
# ğŸ’¬ MÃ³dulo de Chat â€“ Tickets Soporte TI

Este mÃ³dulo implementa el sistema de conversaciÃ³n en tiempo real entre **Usuario** y **Administrador (SUPER USUARIO)** dentro del sistema de Tickets de Soporte TI.

Incluye:

- ğŸ”„ ComunicaciÃ³n en tiempo real con WebSocket (Ratchet)
- ğŸ’¬ Mensajes de texto
- ğŸ“ EnvÃ­o de archivos (imÃ¡genes y documentos)
- ğŸ–¼ï¸ Vista previa de imÃ¡genes
- ğŸ—„ï¸ Persistencia en base de datos
- ğŸ” ValidaciÃ³n de sesiÃ³n PHP

---

# ğŸ—ï¸ Arquitectura General



Usuario (Frontend JS)
â†• WebSocket (ws://:8080)
ChatServer.php (Ratchet)
â†•
Backend PHP (REST)
â†•
Base de Datos (MySQL)


---

# ğŸ‘¤ Chat Usuario

ğŸ“‚ UbicaciÃ³n:


/frontend/dashboard/usuario/


## âœ¨ Funcionalidades

- Ver listado de tickets
- Abrir detalle del ticket
- Enviar mensajes en tiempo real
- Enviar archivos mediante:
  - ğŸ“ Selector de archivos
  - ğŸ“‹ Pegado desde portapapeles
- Visualizar imÃ¡genes dentro del chat
- Modal para ampliar imÃ¡genes

---

## ğŸ”Œ Flujo de Mensaje (Usuario)

1. Usuario escribe mensaje
2. Se envÃ­a a:


backend/tickets/user_reply.php

3. Se guarda en base de datos
4. Se notifica por WebSocket
5. Admin recibe mensaje en tiempo real

---

## ğŸ“ EnvÃ­o de Archivos (Usuario)

Endpoint:



backend/tickets/upload_file.php


Soporta:

- ğŸ–¼ï¸ jpg, jpeg, png, gif, webp
- ğŸ“„ pdf
- ğŸ“ doc, docx
- ğŸ“Š xls, xlsx

### ğŸ”’ Seguridad

- ValidaciÃ³n de sesiÃ³n activa
- LÃ­mite mÃ¡ximo: **10MB**
- ValidaciÃ³n de extensiÃ³n
- Redimensionamiento automÃ¡tico de imÃ¡genes > 1920px
- Nombre Ãºnico generado con `uniqid()`

---

# ğŸ› ï¸ Chat Administrador

ğŸ“‚ UbicaciÃ³n:


/frontend/dashboard/admin/


## âœ¨ Funcionalidades

- Visualizar detalles completos del ticket
- Cambiar estado del ticket:
  - Abierto
  - En Proceso
  - En Espera
  - Cerrado
- Enviar mensajes en tiempo real
- Enviar archivos
- Visualizar archivos enviados por usuario
- Indicador de hora del mensaje

---

## ğŸ”Œ Flujo de Mensaje (Admin)

1. Admin escribe mensaje
2. Se envÃ­a a:


backend/tickets/admin_reply.php

3. Se guarda en base de datos
4. Se emite evento WebSocket
5. Usuario recibe mensaje en tiempo real

---

# ğŸ”„ WebSocket (Ratchet)

ğŸ“‚ Archivo:


ChatServer.php


## ğŸ¯ Funciones

- `join` â†’ Asocia conexiÃ³n a un ticket_id
- `message` â†’ EnvÃ­a mensaje a todos los clientes del mismo ticket
- `file` â†’ EnvÃ­a evento de archivo subido

### ğŸ“¡ Puerto


ws://hostname:8080


---

## ğŸ§  LÃ³gica Interna

```php
$this->clients[$conn->resourceId] = [
    'conn' => $conn,
    'ticket_id' => null
];


Filtra por ticket_id para enviar solo a participantes del mismo ticket.

ğŸ—„ï¸ Base de Datos

Tabla principal:


ticket_comentarios



Campos relevantes:

ticket_id

autor (usuario / admin)

tipo (texto / archivo)

comentario

archivo

nombre_archivo

created_at

ğŸ–¼ï¸ Manejo de ImÃ¡genes
ğŸ”¹ Frontend

Si es imagen â†’ se renderiza <img>

Si es documento â†’ se renderiza <a target="_blank">

Modal para ampliaciÃ³n

ğŸ”¹ Backend

Redimensiona imÃ¡genes mayores a 1920px

Convierte a JPG optimizado (calidad 80)

ğŸ” Seguridad

ValidaciÃ³n de sesiÃ³n en cada endpoint

Cookies PHP con credentials: 'include'

Control de tamaÃ±o de archivo

ValidaciÃ³n de tipo permitido

Aislamiento por ticket_id en WebSocket

ğŸŒ HTTP vs HTTPS

Actualmente configurado para funcionar en:


http://servidor



Para usar HTTPS se requiere:

Certificado SSL vÃ¡lido

WebSocket seguro wss://

Cookies Secure habilitadas

ConfiguraciÃ³n de Apache con SSL

ğŸ“¦ Estructura de Archivos Relevantes

backend/
â”œâ”€â”€ tickets/
â”‚   â”œâ”€â”€ user_reply.php
â”‚   â”œâ”€â”€ admin_reply.php
â”‚   â”œâ”€â”€ upload_file.php
â”‚   â”œâ”€â”€ get_messages.php
â”‚   â””â”€â”€ get_ticket_user.php
â”‚
â”œâ”€â”€ websocket/
â”‚   â””â”€â”€ ChatServer.php

frontend/
â”œâ”€â”€ dashboard/
â”‚   â”œâ”€â”€ usuario/
â”‚   â”‚   â””â”€â”€ dashboard.js
â”‚   â””â”€â”€ admin/
â”‚       â””â”€â”€ ticket.js


ğŸš€ Flujo Completo del Sistema

1ï¸âƒ£ Usuario crea ticket
2ï¸âƒ£ Admin abre ticket
3ï¸âƒ£ ConversaciÃ³n en tiempo real
4ï¸âƒ£ Archivos almacenados en /uploads
5ï¸âƒ£ Persistencia completa en BD
6ï¸âƒ£ SincronizaciÃ³n mediante WebSocket

ğŸ§ª Pruebas Recomendadas

EnvÃ­o de mensaje texto usuario â†’ admin

EnvÃ­o de mensaje texto admin â†’ usuario

Subida imagen usuario â†’ admin

Subida documento admin â†’ usuario

Cambio de estado en tiempo real

ValidaciÃ³n de sesiÃ³n expirada

ğŸ‘¨â€ğŸ’» TecnologÃ­as Utilizadas

PHP 8.x

MySQL

JavaScript Vanilla

Ratchet WebSocket

Apache 2 (Debian 11)

HTML5 / CSS3

ğŸ“Œ Notas TÃ©cnicas

El sistema usa WebSocket para evitar polling.

Los archivos se almacenan fÃ­sicamente en /uploads.

Las imÃ¡genes se optimizan automÃ¡ticamente.

Compatible con entorno local en red LAN.

ğŸ Estado del MÃ³dulo

âœ… Funcional en entorno HTTP
âš™ï¸ Listo para migraciÃ³n a HTTPS con ajustes WSS

Autor: Sistema Tickets Soporte TI
MÃ³dulo: Chat Usuario / Admin